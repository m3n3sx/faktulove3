{% extends "admin/index.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/polish_business_admin.css' %}">
<style>
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease;
}

.stat-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-card h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #1e40af;
    margin-bottom: 0.5rem;
}

.stat-change {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.stat-change.positive {
    background: rgba(16, 185, 129, 0.1);
    color: #047857;
}

.stat-change.negative {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}

.health-indicators {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.health-indicator {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.health-indicator:last-child {
    border-bottom: none;
}

.health-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.75rem;
}

.health-status.healthy {
    background: #10b981;
}

.health-status.warning {
    background: #f59e0b;
}

.health-status.error {
    background: #ef4444;
}

.recent-activity {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
}

.activity-item {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 0.8rem;
    color: white;
}

.activity-icon.invoice {
    background: #3b82f6;
}

.activity-icon.ocr {
    background: #8b5cf6;
}

.activity-content {
    flex: 1;
}

.activity-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.activity-description {
    color: #666;
    font-size: 0.85rem;
}

.activity-time {
    color: #999;
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.company-selector {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.company-selector h3 {
    margin: 0 0 0.5rem 0;
    color: #1e40af;
}

.company-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.company-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #3b82f6;
    background: white;
    color: #3b82f6;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.company-btn:hover {
    background: #3b82f6;
    color: white;
}

.company-btn.active {
    background: #3b82f6;
    color: white;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    color: #dc2626;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<h1>{% trans 'FaktuLove Administration' %}</h1>

<!-- Company Selector -->
{% if user_companies %}
<div class="company-selector">
    <h3>{% trans 'Wybierz firmę' %}</h3>
    <div class="company-buttons">
        {% for company in user_companies %}
        <a href="{% url 'admin:switch_company' company.id %}" 
           class="company-btn {% if company == current_company %}active{% endif %}">
            {{ company.nazwa }}
        </a>
        {% endfor %}
    </div>
    {% if current_company %}
    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
        Aktywna firma: <strong>{{ current_company.nazwa }}</strong>
    </p>
    {% endif %}
</div>
{% endif %}

<!-- Dashboard Statistics -->
<div id="dashboard-stats" class="dashboard-stats">
    <div class="loading">Ładowanie statystyk...</div>
</div>

<!-- System Health -->
<div class="health-indicators">
    <h2>{% trans 'Stan systemu' %}</h2>
    <div id="health-indicators">
        <div class="loading">Sprawdzanie stanu systemu...</div>
    </div>
</div>

<!-- Recent Activity -->
<div class="recent-activity">
    <h2>{% trans 'Ostatnia aktywność' %}</h2>
    <div id="recent-activity">
        <div class="loading">Ładowanie aktywności...</div>
    </div>
</div>

<!-- Original Django Admin Content -->
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadSystemHealth();
    loadRecentActivity();
    
    // Refresh data every 5 minutes
    setInterval(function() {
        loadDashboardStats();
        loadSystemHealth();
    }, 300000);
});

function loadDashboardStats() {
    fetch('{% url "admin:dashboard_stats" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('dashboard-stats').innerHTML = 
                    '<div class="error">Błąd ładowania statystyk: ' + data.error + '</div>';
                return;
            }
            
            const statsHtml = `
                <div class="stat-card">
                    <h3>Faktury</h3>
                    <div class="stat-value">${data.invoices.total}</div>
                    <div>W tym miesiącu: ${data.invoices.this_month}</div>
                </div>
                <div class="stat-card">
                    <h3>Przychód (PLN)</h3>
                    <div class="stat-value">${formatCurrency(data.revenue.this_month)}</div>
                    <div class="stat-change ${data.revenue.change_percent >= 0 ? 'positive' : 'negative'}">
                        ${data.revenue.change_percent >= 0 ? '+' : ''}${data.revenue.change_percent.toFixed(1)}%
                    </div>
                </div>
                <div class="stat-card">
                    <h3>OCR dzisiaj</h3>
                    <div class="stat-value">${data.ocr.processed_today}</div>
                    <div>Skuteczność: ${data.ocr.success_rate.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <h3>Podmioty</h3>
                    <div class="stat-value">${data.entities.companies}</div>
                    <div>Kontrahenci: ${data.entities.contractors}</div>
                </div>
            `;
            
            document.getElementById('dashboard-stats').innerHTML = statsHtml;
        })
        .catch(error => {
            console.error('Error loading dashboard stats:', error);
            document.getElementById('dashboard-stats').innerHTML = 
                '<div class="error">Błąd połączenia z serwerem</div>';
        });
}

function loadSystemHealth() {
    fetch('{% url "admin:system_health" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('health-indicators').innerHTML = 
                    '<div class="error">Błąd sprawdzania stanu: ' + data.error + '</div>';
                return;
            }
            
            let healthHtml = '';
            for (const [key, check] of Object.entries(data.checks)) {
                healthHtml += `
                    <div class="health-indicator">
                        <div class="health-status ${check.status}"></div>
                        <div>
                            <strong>${getHealthCheckTitle(key)}</strong><br>
                            <span style="color: #666; font-size: 0.85rem;">${check.message}</span>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('health-indicators').innerHTML = healthHtml;
        })
        .catch(error => {
            console.error('Error loading system health:', error);
            document.getElementById('health-indicators').innerHTML = 
                '<div class="error">Błąd połączenia z serwerem</div>';
        });
}

function loadRecentActivity() {
    fetch('{% url "admin:recent_activity" %}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('recent-activity').innerHTML = 
                    '<div class="error">Błąd ładowania aktywności: ' + data.error + '</div>';
                return;
            }
            
            let activityHtml = '';
            data.activity.forEach(item => {
                const iconClass = item.type.includes('invoice') ? 'invoice' : 'ocr';
                const iconText = item.type.includes('invoice') ? 'F' : 'O';
                
                activityHtml += `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}">${iconText}</div>
                        <div class="activity-content">
                            <div class="activity-title">
                                ${item.url ? `<a href="${item.url}">${item.title}</a>` : item.title}
                            </div>
                            <div class="activity-description">${item.description}</div>
                            <div class="activity-time">${formatDateTime(item.timestamp)}</div>
                        </div>
                    </div>
                `;
            });
            
            if (activityHtml === '') {
                activityHtml = '<div style="text-align: center; color: #666; padding: 2rem;">Brak ostatniej aktywności</div>';
            }
            
            document.getElementById('recent-activity').innerHTML = activityHtml;
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            document.getElementById('recent-activity').innerHTML = 
                '<div class="error">Błąd połączenia z serwerem</div>';
        });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('pl-PL', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

function formatDateTime(timestamp) {
    if (!timestamp) return 'N/A';
    
    const date = new Date(timestamp);
    return new Intl.DateTimeFormat('pl-PL', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

function getHealthCheckTitle(key) {
    const titles = {
        'database': 'Baza danych',
        'ocr_engines': 'Silniki OCR',
        'storage': 'Przechowywanie plików',
        'recent_errors': 'Ostatnie błędy'
    };
    return titles[key] || key;
}
</script>
{% endblock %}